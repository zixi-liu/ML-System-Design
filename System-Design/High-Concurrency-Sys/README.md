## 高并发系统架构学习笔记

[作者](https://time.geekbang.org/column/intro/100105701)

### 01 高并发架构设计方法
服务系统随着并发的增加从而拓展系统的各个方面来消除性能瓶颈。

应对高并发流量的通用解决方案：
- Scale-out(分布式)
- 缓存(使用缓存来提高系统的性能)
- 异步(某些场景下，未处理完成之前我们可以让请求先返回，在数据准备好之后再通知请求方，这样可以在单位时间内处理更多的请求。)

**垂直伸缩**：提高单台服务器的处理能力。

**水平伸缩**：使用更多的服务器，将这些服务器构成一个分布式集群。具有更好的弹性。

**分布式应用**

每个用户请求都需要分配一个线程去处理，而每个线程又需要占用一定的CPU和内存资源。当高并发的用户请求达到时，应用服务器需要创建大量线程，消耗大量计算机资源。

解决这个问题的主要手段是使用负载均衡服务器。
- 将多台应用服务器构成一个分布式集群，用户请求首先到达负载均衡服务器，然后由负载均衡服务器将请求分发到不同的应用服务器上。这样每台服务器创建的线程都不会太多，占用资源也在合理范围内。

**分布式缓存**

使用缓存的主要作用是提升系统的访问性能（由于磁盘读取较慢，因此将内存作为存储介质来降低响应时间）。

首先应用程序调用分布式缓存的客户端SDK，SDK会根据应用程序传入的key进行路由选择，从分布式缓存集群中选择一台缓存服务器进行访问。如果分布式缓存中不存在要访问的数据，应用程序就直接访问数据库，从数据库中获取数据，然后将该数据写入到缓存中。

**分布式消息队列**

消息队列是解决突发高并发写操作、实现集群伸缩和应用解耦的有效方法。
- MQ缓冲流量，削峰填谷：
  - 站点与服务上下游之间通讯，不管采用“直接调用”还是“MQ推送”，都有一个缺点，下游消息接收方无法控制到达自己的流量，如果调用方不限速，很有可能把下游压垮。
  - 由MQ-server推模式，升级为MQ-client拉模式。MQ-client根据自己的处理能力，每隔一定时间，或每次拉取若干条消息，实施流控。
  - 提升整体吞吐量，需要下游优化，例如批量处理等方式（消息接收方需要做的）。

**同步与异步**

- 同步调用代表调用方要阻塞等待被调用方法中的逻辑执行完成。这种方式下，当被调用方法响应时间较长时，会造成调用方长久的阻塞，在高并发下会造成整体系统性能下降。
- 异步调用，调用方不需要等待方法逻辑执行完成就可以返回执行其他的逻辑，在被调用方法执行完毕后再通过回调、事件通知等方式将结果反馈给调用方。

将单体架构中庞大的业务逻辑拆分成一些更小、更低耦合的服务，然后通过服务间的调用完成业务的处理。

**系统并发指标**

- 目标用户数
- 系统用户数
- 活跃用户数
- 在线用户数
- 并发用户数

根据用户指标，估算技术指标-每天新增的文件存储空间，存储总系统用户需要的数据库规模，总网络带宽，每秒处理的请求数等等。

### 02 数据库


**池化：减少频繁创建数据库连接的性能损耗**

数据库连接池：最小连接数和最大连接数。

如何保证连接池可用：启动一个线程来定期检测连接池中的连接是否可用。

核心思想是空间换时间，期望使用预先创建好的对象来减少频繁创建对象的性能开销。

**NoSQL**

- Redis、LevelDB 这样的 KV 存储。这类存储相比于传统的数据库的优势是极高的读写性能。
- Hbase、Cassandra 这样的列式存储数据库。这种数据库的特点是数据不像传统数据库以行为单位来存储，而是以列来存储，适用于一些离线数据统计的场景。
- MongoDB、CouchDB 这样的文档型数据库。这种数据库的特点是 Schema Free（模式自由），数据表中的字段可以任意扩展。


### 03 缓存



### 06 短视频系统设计

存储短视频文件需要更大的存储空间，播放短视频也需要更多的网络带宽。

**概要设计**

<img width="800" alt="image" src="https://user-images.githubusercontent.com/46979228/167347057-ad1430d9-68a4-45dc-b466-dc96fa63c145.png">

视频内容处理器

<img width="800" alt="image" src="https://user-images.githubusercontent.com/46979228/167347511-f8ea2b75-5a73-459f-be04-91e445daaf2b.png">

视频上传环节时序图

<img width="800" alt="image" src="https://user-images.githubusercontent.com/46979228/167347692-93e5b0e1-1033-4145-90a6-50be02268cab.png">

视频搜索引擎会根据用户提交的视频标题、上传用户等元数据，以及视频内容处理器生成的内容标签构建倒排索引。当用户搜索视频时，系统会根据倒排索引来检索符合条件的视频，并返回结果列表。

当用户点击缩略图时，App开始播放视频。App并不需要下载完成整个视频文件才开始播放，而是以流的方式一边下载视频数据，一边播放。

**详细设计**

“如何生成更吸引用户的缩略图”

**视频存储系统设计**

使用Hadoop分布式文件系统HDFS进行储存。HDFS适合大文件存储一次写入多次读取的场景。HDFS适合储存大文件，大文件减少磁盘碎片，有利于存储空间的利用。需要把若干个视频文件合并成一个HDFS文件进行储存，并将存储相关的细节记录到HBase中。

**性能优化与CDN(Content Delivery Network)设计**

通过CDN加大用户请求的响应速度，缓解数据中心的网络和硬盘负载压力。
- CDN推送服务根据粉丝活跃的区域，将视频推送到对应区域的CDN服务器上。
- 根据视频发布者的历史播放记录，计算其完播率和播放期望进度，然后将短视频切分成若干chunk，将部分chunk推送到CDN。
- 视频应用CDN处理的带宽大约占总带宽的95%以上。

**缩略图生成与推荐设计**

<img width="800" alt="image" src="https://user-images.githubusercontent.com/46979228/167352105-48acc1a0-9f9c-404d-9459-9817a23b47d5.png">

缩略图的生成和推荐可以分为2个具体过程：
- 实时在线的缩略图推荐过程a；
- 利用离线机器学习生成优质缩略图的过程b；

a过程中，一个视频可能对应很多个缩略图，如果想要显示最吸引当前用户的那个，搜索引擎需要调用大数据平台的缩略图推荐引擎进行推荐。

推荐引擎可以获取当前用户的偏好特征标签以及视频对应的多个缩略图特征，使用训练好的模型，将用户特征标签和缩略图特征进行匹配，然后返回最有可能被当前用户点击的缩略图ID。搜索引擎再按照ID将对应的缩略图构建到搜索结果页面，返回给用户。

用户浏览搜索结果列表，点击某些缩略图进行播放。App应用会将用户的浏览与点击数据发送给大数据平台，这样就进入利用机器学习来生成优质缩略图的过程b。机器学习可以学习哪些特征的缩略图更容易获得用户点击，从而生成优质缩略图特征标签库。机器还可以学习到每个用户自身更偏好的图像特征标签，供推荐引擎使用。

视频处理器可以使用优质特征标签库来处理上传的视频内容，抽取符合优质特征的帧，进而生成缩略图。

以上的a、b两个过程不断循环迭代，系统不断优化优质特征标签库，不断使缩略图更符合用户喜好。

冷启动-视频内容处理器使用随机的办法，抽取一些帧作为缩略图，机器学习再从这些随机抽取的缩略图上开始学习，从而进入循环优化。

